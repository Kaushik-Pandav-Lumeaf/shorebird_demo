name: Shorebird CI

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Choose what to run"
        required: true
        default: "patch"
        type: choice
        options:
          - release
          - patch
  push:
    branches:
      - main

jobs:
  # -------------------------------
  # FULL RELEASE: Android + iOS
  # -------------------------------
  release:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'release'
    strategy:
      matrix:
        platform: [android, ios]
      fail-fast: false
    runs-on: ${{ matrix.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'

      # Install Shorebird CLI, set PATH, verify
      - name: Install and verify Shorebird CLI
        run: |
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version

      # Shorebird login
      - name: Shorebird Login
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          shorebird login --api-key $SHOREBIRD_TOKEN
          shorebird whoami

      # Release step
      - name: Shorebird Release (${{ matrix.platform }})
        run: |
          RELEASE_VERSION="1.0.${{ github.run_number }}"
          echo "Releasing version $RELEASE_VERSION"
          shorebird release ${{ matrix.platform }} --release-version $RELEASE_VERSION

  # -------------------------------
  # PATCH: Android + iOS
  # -------------------------------
  patch:
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'patch') ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, 'hotfix:') || contains(github.event.head_commit.message, 'patch:')))
    strategy:
      matrix:
        platform: [android, ios]
      fail-fast: false
    runs-on: ${{ matrix.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'

      # Install Shorebird CLI, set PATH, verify
      - name: Install and verify Shorebird CLI
        run: |
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          export PATH="$HOME/.shorebird/bin:$PATH"
          shorebird --version

      # Shorebird login
      - name: Shorebird Login
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: |
          shorebird login --api-key $SHOREBIRD_TOKEN
          shorebird whoami

      # Debug environment (optional, can remove after confirmation)
      - name: Debug environment
        run: |
          echo "PATH: $PATH"
          which shorebird
          shorebird --version

      # Patch step
      - name: Shorebird Patch (${{ matrix.platform }})
        run: |
          PATCH_VERSION="1.0.${{ github.run_number }}"
          echo "Patching version $PATCH_VERSION"
          shorebird patch ${{ matrix.platform }} --release-version $PATCH_VERSION
