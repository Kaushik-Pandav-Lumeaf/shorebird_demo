name: Shorebird CI

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Choose what to run"
        required: true
        default: "patch"
        type: choice
        options:
          - release
          - patch
  push:
    branches:
      - main

jobs:
  # -------------------------------
  # FULL RELEASE: Android + iOS
  # -------------------------------
  release:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'release'
    strategy:
      matrix:
        platform: [ android, ios ]
    runs-on: ${{ matrix.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'

      - name: Install Shorebird CLI
        run: |
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          echo "$HOME/.shorebird/bin" >> $GITHUB_PATH

      - name: Verify Shorebird version
        run: shorebird --version

      - name: Shorebird login
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: shorebird login --api-key $SHOREBIRD_TOKEN

      - name: Shorebird Release (${{ matrix.platform }})
        run: |
          shorebird release ${{ matrix.platform }} \
            --release-version 1.0.${{ github.run_number }}

  # -------------------------------
  # PATCH: Android + iOS
  # -------------------------------
  patch:
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'patch') ||
      (github.event_name == 'push' && (contains(github.event.head_commit.message, 'hotfix:') || contains(github.event.head_commit.message, 'patch:')))
    strategy:
      matrix:
        platform: [ android, ios ]
    runs-on: ${{ matrix.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'

      - name: Install Shorebird CLI
        run: |
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          echo "$HOME/.shorebird/bin" >> $GITHUB_PATH

      - name: Verify Shorebird version
        run: shorebird --version

      - name: Shorebird login
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
        run: shorebird login --api-key $SHOREBIRD_TOKEN

      - name: Shorebird Patch (${{ matrix.platform }})
        run: |
          shorebird patch ${{ matrix.platform }}
